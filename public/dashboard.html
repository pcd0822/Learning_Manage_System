<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‚¬ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="css/style.css">
    <script type="module">
        import { loginWithGoogle, logout, checkAuthState } from './js/auth.js';
        import { db, collection, query, where, getDocs, addDoc, doc, updateDoc, getDoc } from './js/firebase-config.js';

        let currentUser = null;
        let currentView = 'card'; // 'card' or 'list'
        let currentFolderId = null; // null means root
        let currentFolderName = 'Home';
        let breadcrumbPath = [{ id: null, name: 'Home' }];

        window.logoutUser = async () => {
            await logout();
            window.location.href = 'teacher.html';
        };

        window.toggleView = (view) => {
            currentView = view;
            document.getElementById('btnCardView').classList.toggle('active', view === 'card');
            document.getElementById('btnListView').classList.toggle('active', view === 'list');
            loadContent();
        };

        checkAuthState(async (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('userName').textContent = user.displayName;
                loadContent();
            } else {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'teacher.html';
            }
        });

        async function loadContent() {
            const container = document.getElementById('quizList');
            container.innerHTML = '<div class="spinner"></div>';
            updateBreadcrumb();

            try {
                // 1. Fetch Folders (only if in root or subfolder logic implemented)
                // For now, folders are only at root level or nested? Let's assume single level nesting for simplicity first, or recursive.
                // Let's query folders where parentId == currentFolderId
                const folderQ = query(collection(db, "folders"), where("userId", "==", currentUser.uid), where("parentId", "==", currentFolderId));
                const folderSnap = await getDocs(folderQ);

                const folders = [];
                folderSnap.forEach(doc => folders.push({ id: doc.id, ...doc.data(), type: 'folder' }));

                // 2. Fetch Quizzes
                // Query quizzes where folderId == currentFolderId
                // Note: Legacy quizzes have no folderId. We treat missing folderId as root (null).
                // But Firestore query for missing field is tricky.
                // If currentFolderId is null, we want quizzes with folderId == null OR folderId does not exist.
                // Easier: Fetch all quizzes for user and filter client side for now (since we don't have many).
                // Optimization: Add 'folderId: null' to all new quizzes.

                const quizQ = query(collection(db, "quizzes"), where("userId", "==", currentUser.uid));
                const quizSnap = await getDocs(quizQ);

                const quizzes = [];
                quizSnap.forEach(doc => {
                    const data = doc.data();
                    // Filter by folder
                    if (currentFolderId === null) {
                        if (!data.folderId) quizzes.push({ id: doc.id, ...data, type: 'quiz' });
                    } else {
                        if (data.folderId === currentFolderId) quizzes.push({ id: doc.id, ...data, type: 'quiz' });
                    }
                });

                // Sort: Folders first, then Quizzes. Both by name or date? Let's do Date desc.
                // Actually folders usually by name, quizzes by date.
                folders.sort((a, b) => a.name.localeCompare(b.name));
                quizzes.sort((a, b) => b.createdAt.seconds - a.createdAt.seconds);

                const items = [...folders, ...quizzes];

                container.innerHTML = '';

                if (items.length === 0) {
                    container.innerHTML = '<p>ì´ í´ë”ì—ëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                if (currentView === 'card') {
                    container.className = 'grid-container';
                    items.forEach(item => {
                        const div = document.createElement('div');

                        if (item.type === 'folder') {
                            div.className = 'card quiz-card folder-card';
                            div.onclick = () => enterFolder(item.id, item.name);
                            div.innerHTML = `
                                <div class="folder-icon">ğŸ“</div>
                                <h3>${item.name}</h3>
                            `;
                        } else {
                            const date = item.createdAt.toDate().toLocaleDateString();
                            div.className = 'card quiz-card';
                            // Right click context menu
                            div.oncontextmenu = (e) => showContextMenu(e, item.id);
                            div.onclick = () => showResults(item.id, item.title);
                            div.innerHTML = `
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <h3>${item.title}</h3>
                                    <span style="color:#666; font-size:0.9rem;">${date}</span>
                                </div>
                                <p>ë¬¸í•­ ìˆ˜: ${item.data.questions.length}ê°œ</p>
                                <div style="margin-top:1rem; text-align:right;">
                                    <span style="color: var(--primary-color); font-weight:bold;">í´ë¦­í•˜ì—¬ ê²°ê³¼ ë³´ê¸° &rarr;</span>
                                </div>
                            `;
                        }
                        container.appendChild(div);
                    });
                } else {
                    container.className = '';
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>ìœ í˜•</th>
                                <th>ì´ë¦„</th>
                                <th>ìƒì„±ì¼</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;
                    const tbody = table.querySelector('tbody');
                    items.forEach(item => {
                        const tr = document.createElement('tr');
                        if (item.type === 'folder') {
                            tr.innerHTML = `
                                <td>ğŸ“</td>
                                <td style="cursor:pointer; font-weight:bold;" onclick="enterFolder('${item.id}', '${item.name}')">${item.name}</td>
                                <td>-</td>
                                <td>-</td>
                            `;
                        } else {
                            const date = item.createdAt.toDate().toLocaleDateString();
                            const safeTitle = item.title.replace(/'/g, "\\'");
                            tr.innerHTML = `
                                <td>ğŸ“</td>
                                <td>${item.title}</td>
                                <td>${date}</td>
                                <td>
                                    <button class="btn btn-sm" onclick="showResults('${item.id}', '${safeTitle}')">ê²°ê³¼</button>
                                    <button class="btn btn-sm btn-secondary" onclick="moveQuizPrompt('${item.id}')">ì´ë™</button>
                                </td>
                            `;
                        }
                        tbody.appendChild(tr);
                    });
                    container.appendChild(table);
                }

            } catch (e) {
                console.error(e);
                container.innerHTML = `<p style="color:red;">ì˜¤ë¥˜ ë°œìƒ: ${e.message}</p>`;
            }
        }

        window.enterFolder = (id, name) => {
            currentFolderId = id;
            currentFolderName = name;
            breadcrumbPath.push({ id, name });
            loadContent();
        };

        window.navigateTo = (index) => {
            breadcrumbPath = breadcrumbPath.slice(0, index + 1);
            const target = breadcrumbPath[index];
            currentFolderId = target.id;
            currentFolderName = target.name;
            loadContent();
        };

        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = '';
            breadcrumbPath.forEach((item, index) => {
                const span = document.createElement('span');
                span.className = 'breadcrumb-item';
                span.textContent = item.name;
                span.onclick = () => navigateTo(index);
                breadcrumb.appendChild(span);

                if (index < breadcrumbPath.length - 1) {
                    const sep = document.createElement('span');
                    sep.className = 'breadcrumb-separator';
                    sep.textContent = ' > ';
                    breadcrumb.appendChild(sep);
                }
            });
        }

        window.createFolder = async () => {
            const name = prompt("ìƒˆ í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
            if (!name) return;

            try {
                await addDoc(collection(db, "folders"), {
                    userId: currentUser.uid,
                    name: name,
                    parentId: currentFolderId,
                    createdAt: new Date()
                });
                loadContent();
            } catch (e) {
                alert("í´ë” ìƒì„± ì‹¤íŒ¨: " + e.message);
            }
        };

        // Context Menu Logic
        let selectedQuizId = null;

        window.showContextMenu = (e, quizId) => {
            e.preventDefault();
            selectedQuizId = quizId;
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = `${e.pageX}px`;
            menu.style.top = `${e.pageY}px`;
        };

        window.onclick = (e) => {
            document.getElementById('contextMenu').style.display = 'none';
            if (e.target == document.getElementById('resultModal')) {
                document.getElementById('resultModal').style.display = 'none';
            }
            if (e.target == document.getElementById('addQuizModal')) {
                document.getElementById('addQuizModal').style.display = 'none';
            }
        };

        window.moveQuizPrompt = async (quizId = selectedQuizId) => {
            // Show modal with folder list to move to
            // For simplicity, let's just use a prompt or a simple modal.
            // Let's use a prompt for now asking for folder name? No, that's hard.
            // Let's show a simple list of folders in a modal.

            // Re-use Add Quiz Modal logic but reversed? 
            // Let's just implement "Move to Root" and "Move to..." (requires UI).
            // For MVP requested: "í•™ìŠµìë£Œë¥¼ ìš°í´ë¦­í•´ì„œ í´ë”ë¡œ ë¶„ë¥˜í•  ìˆ˜ ìˆë„ë¡ í•˜ê³ "

            // Let's fetch all folders and show in a prompt-like overlay
            const folders = await fetchAllFolders();
            let list = "ì´ë™í•  í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”:\n0. ìµœìƒìœ„ (Root)\n";
            folders.forEach((f, i) => {
                list += `${i + 1}. ${f.name}\n`;
            });

            const choice = prompt(list);
            if (choice === null) return;

            const index = parseInt(choice);
            let targetId = null;

            if (index === 0) targetId = null;
            else if (index > 0 && index <= folders.length) targetId = folders[index - 1].id;
            else return alert("ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.");

            try {
                await updateDoc(doc(db, "quizzes", quizId), {
                    folderId: targetId
                });
                loadContent();
            } catch (e) {
                alert("ì´ë™ ì‹¤íŒ¨: " + e.message);
            }
        };

        async function fetchAllFolders() {
            const q = query(collection(db, "folders"), where("userId", "==", currentUser.uid));
            const snap = await getDocs(q);
            const folders = [];
            snap.forEach(doc => folders.push({ id: doc.id, ...doc.data() }));
            return folders;
        }

        // Add Quiz to Folder (from within folder)
        window.openAddQuizModal = async () => {
            if (currentFolderId === null) return alert("í´ë” ë‚´ë¶€ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

            const modal = document.getElementById('addQuizModal');
            const list = document.getElementById('addQuizList');
            modal.style.display = 'flex';
            list.innerHTML = '<div class="spinner"></div>';

            // Fetch quizzes that are in Root (folderId == null)
            // We assume "Add Quiz" means bringing in unorganized quizzes.
            const q = query(collection(db, "quizzes"), where("userId", "==", currentUser.uid));
            const snap = await getDocs(q);

            list.innerHTML = '';
            let count = 0;
            snap.forEach(doc => {
                const data = doc.data();
                if (!data.folderId) { // Only show root quizzes
                    count++;
                    const div = document.createElement('div');
                    div.style.padding = '0.5rem';
                    div.style.borderBottom = '1px solid #eee';
                    div.style.display = 'flex';
                    div.style.justifyContent = 'space-between';
                    div.innerHTML = `
                        <span>${data.title}</span>
                        <button class="btn btn-sm" onclick="moveQuizToCurrent('${doc.id}')">ì¶”ê°€</button>
                    `;
                    list.appendChild(div);
                }
            });

            if (count === 0) list.innerHTML = '<p>ì¶”ê°€í•  ìˆ˜ ìˆëŠ” ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤ (ëª¨ë‘ ë¶„ë¥˜ë¨).</p>';
        };

        window.moveQuizToCurrent = async (quizId) => {
            try {
                await updateDoc(doc(db, "quizzes", quizId), {
                    folderId: currentFolderId
                });
                // Remove from list
                openAddQuizModal(); // Refresh
                loadContent(); // Refresh background
            } catch (e) {
                alert("ì¶”ê°€ ì‹¤íŒ¨: " + e.message);
            }
        };

        window.closeAddQuizModal = () => {
            document.getElementById('addQuizModal').style.display = 'none';
        };

        // Existing Result Logic
        window.showResults = async (quizId, title) => {
            const modal = document.getElementById('resultModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = `'${title}' ì°¸ì—¬ í˜„í™©`;
            modalBody.innerHTML = '<div class="spinner"></div>';
            modal.style.display = 'flex';

            console.log("Searching results for Firestore Quiz ID:", quizId);

            try {
                const q = query(collection(db, "results"), where("firestoreId", "==", quizId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    modalBody.innerHTML = `
                        <p>ì°¸ì—¬í•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p style="font-size:0.8rem; color:#999;">Debug: Quiz ID ${quizId}</p>
                        <p style="font-size:0.9rem; color:#666;">
                            * ì°¸ê³ : ìµœê·¼ ì—…ë°ì´íŠ¸ ì´ì „ì— ìƒì„±ëœ í€´ì¦ˆ ë§í¬ë¡œ ì°¸ì—¬í•œ ê²½ìš°, ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                            ìƒˆë¡œ í€´ì¦ˆë¥¼ ìƒì„±í•˜ì—¬ í…ŒìŠ¤íŠ¸í•´ì£¼ì„¸ìš”.
                        </p>
                    `;
                    return;
                }

                const results = [];
                querySnapshot.forEach(doc => {
                    results.push(doc.data());
                });
                results.sort((a, b) => b.submittedAt.seconds - a.submittedAt.seconds);

                let html = `
                    <table class="result-table">
                        <thead>
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>ì ìˆ˜</th>
                                <th>ì •ë‹µë¥ </th>
                                <th>ì†Œìš”ì‹œê°„</th>
                                <th>ì œì¶œì¼ì‹œ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                results.forEach(r => {
                    const time = r.submittedAt.toDate().toLocaleString();
                    html += `
                        <tr>
                            <td>${r.studentName}</td>
                            <td>${r.score} / ${r.total}</td>
                            <td>${r.accuracy}%</td>
                            <td>${r.timeTaken}</td>
                            <td>${time}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                modalBody.innerHTML = html;

            } catch (e) {
                console.error(e);
                modalBody.innerHTML = `<p style="color:red;">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>${e.message}</p>`;
            }
        };

        window.closeModal = () => {
            document.getElementById('resultModal').style.display = 'none';
        };
    </script>
</head>

<body>
    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center;">
            <h1>ëŒ€ì‹œë³´ë“œ</h1>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span id="userName" style="margin-right: 0.5rem; font-weight: bold;"></span>
                <button class="btn btn-secondary" onclick="logoutUser()"
                    style="width: auto; padding: 0.5rem 1rem; margin: 0;">ë¡œê·¸ì•„ì›ƒ</button>
                <a href="teacher.html" class="btn" style="width: auto; padding: 0.5rem 1rem; margin: 0;">ìƒˆ í€´ì¦ˆ ë§Œë“¤ê¸°</a>
            </div>
        </header>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div id="breadcrumb" class="breadcrumb">
                <!-- Breadcrumbs -->
            </div>
            <div class="view-toggle" style="margin-bottom: 0;">
                <button class="btn btn-sm" onclick="createFolder()" style="margin-right: 0.5rem;">+ í´ë” ìƒì„±</button>
                <button class="btn btn-sm" onclick="openAddQuizModal()" style="margin-right: 0.5rem;">+ ìë£Œ ê°€ì ¸ì˜¤ê¸°</button>
                <button class="toggle-btn active" id="btnCardView" onclick="toggleView('card')">ì¹´ë“œ</button>
                <button class="toggle-btn" id="btnListView" onclick="toggleView('list')">ëª©ë¡</button>
            </div>
        </div>

        <div id="quizList">
            <!-- Content will be loaded here -->
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">ì°¸ì—¬ í˜„í™©</h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Add Quiz Modal -->
    <div id="addQuizModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-btn" onclick="closeAddQuizModal()">&times;</span>
            <h2>ìë£Œ ê°€ì ¸ì˜¤ê¸°</h2>
            <p>ë¶„ë¥˜ë˜ì§€ ì•Šì€ ìë£Œë¥¼ í˜„ì¬ í´ë”ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.</p>
            <div id="addQuizList" style="max-height: 400px; overflow-y: auto; margin-top: 1rem;"></div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="moveQuizPrompt()">í´ë”ë¡œ ì´ë™...</div>
    </div>
</body>

</html>
