<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ - í€´ì¦ˆ í’€ê¸°</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>í•™ìŠµ í€´ì¦ˆ</h1>
        </header>

        <!-- Login Section -->
        <div class="card" id="loginCard">
            <h2>ì‹œì‘í•˜ê¸°</h2>
            <p>ì´ë¦„ì„ ì…ë ¥í•˜ê³  í•™ìŠµì„ ì‹œì‘í•˜ì„¸ìš”.</p>
            <input type="text" id="studentName" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)">
            <button class="btn" onclick="startQuiz()">í•™ìŠµ ì‹œì‘</button>
        </div>

        <!-- Loading -->
        <div id="loading">
            <div class="spinner"></div>
            <p>ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>

        <!-- Quiz Section -->
        <div class="card" id="quizCard" style="display: none;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                <h2 id="quizTitle">í€´ì¦ˆ ì œëª©</h2>
                <div id="timer" style="font-weight: bold; color: var(--primary-color);">00:00</div>
            </div>

            <div id="questionsContainer"></div>

            <button class="btn" onclick="submitQuiz()" style="margin-top: 2rem;">ì œì¶œí•˜ê¸°</button>
        </div>

        <!-- Result Section -->
        <div class="card" id="resultCard" style="display: none;">
            <h2>í•™ìŠµ ì™„ë£Œ!</h2>
            <div style="text-align: center; margin: 2rem 0;">
                <h3 style="font-size: 3rem; margin: 0; color: var(--primary-color);" id="scoreDisplay">0ì </h3>
                <p id="accuracyDisplay">ì •ë‹µë¥ : 0%</p>
            </div>
            <p>ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤. ê²°ê³¼ê°€ ì„ ìƒë‹˜ê»˜ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="btn" onclick="startReview()">ì˜¤ë‹µ ë…¸íŠ¸ / ë³µìŠµí•˜ê¸°</button>
                <a href="index.html" class="btn btn-secondary">í™ˆìœ¼ë¡œ (ë³µìŠµ ê±´ë„ˆë›°ê¸°)</a>
            </div>
        </div>

        <!-- Review Section -->
        <div class="card" id="reviewCard" style="display: none;">
            <h2>ì˜¤ë‹µ ë…¸íŠ¸</h2>
            <p>í‹€ë¦° ë¬¸ì œë¥¼ í™•ì¸í•˜ê³  í•´ì„¤ì„ ì½ì–´ë³´ì„¸ìš”.</p>
            <div id="reviewContainer"></div>
            <button class="btn" onclick="finishReview()" style="margin-top: 2rem;">ë³µìŠµ ì™„ë£Œ</button>
        </div>
    </div>

    <script>
        let quizData = null;
        let startTime = null;
        let timerInterval = null;
        let materialId = null;
        let notionKey = null;
        let resultsDb = null;
        let userAnswers = []; // Store answers for review

        // Get ID and Credentials from URL
        const urlParams = new URLSearchParams(window.location.search);
        materialId = urlParams.get('id');
        const encodedKey = urlParams.get('k');
        const encodedDb = urlParams.get('d');

        if (!materialId || !encodedKey || !encodedDb) {
            alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ë§í¬ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
            window.location.href = 'index.html';
        }

        try {
            notionKey = atob(encodedKey);
            resultsDb = atob(encodedDb);
        } catch (e) {
            console.error('Failed to decode credentials');
        }

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'x-notion-token': notionKey,
                'x-results-db': resultsDb
            };
        }

        async function startQuiz() {
            const name = document.getElementById('studentName').value;
            if (!name) return alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            document.getElementById('loginCard').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            try {
                const response = await fetch(`/.netlify/functions/notion?action=fetch&id=${materialId}`, {
                    headers: getHeaders()
                });
                if (!response.ok) throw new Error('Failed to load quiz');

                const data = await response.json();
                quizData = data;

                if (quizData.title) {
                    document.getElementById('quizTitle').textContent = quizData.title;
                }

                renderQuiz();
                startTimer();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('quizCard').style.display = 'block';
            } catch (error) {
                console.error(error);
                alert('í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('loginCard').style.display = 'block';
            }
        }

        function startTimer() {
            startTime = new Date();
            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000);
                const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
                const seconds = (diff % 60).toString().padStart(2, '0');
                document.getElementById('timer').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        function renderQuiz() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            quizData.questions.forEach((q, index) => {
                const div = document.createElement('div');
                div.className = 'question-card';
                div.innerHTML = `<p><strong>Q${index + 1}. ${q.question}</strong></p>`;

                if (q.type === 'ox-quiz') {
                    div.innerHTML += `
                        <div class="ox-container">
                            <button class="ox-btn" onclick="selectOx(this, 'O', ${index})">O</button>
                            <button class="ox-btn" onclick="selectOx(this, 'X', ${index})">X</button>
                            <input type="hidden" name="q${index}" id="q${index}">
                        </div>
                    `;
                } else if (q.options) {
                    q.options.forEach(opt => {
                        div.innerHTML += `
                            <label style="display: block; margin: 0.5rem 0;">
                                <input type="radio" name="q${index}" value="${opt}"> ${opt}
                            </label>
                        `;
                    });
                } else {
                    div.innerHTML += `<input type="text" name="q${index}" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 0.5rem;">`;
                }

                container.appendChild(div);
            });
        }

        function selectOx(btn, value, index) {
            // Remove selected class from siblings
            const container = btn.parentElement;
            container.querySelectorAll('.ox-btn').forEach(b => b.classList.remove('selected'));

            // Add selected class to clicked button
            btn.classList.add('selected');

            // Update hidden input
            document.getElementById(`q${index}`).value = value;
        }

        async function submitQuiz() {
            clearInterval(timerInterval);
            const answers = [];
            let score = 0;
            const total = quizData.questions.length;

            quizData.questions.forEach((q, index) => {
                let userAnswer = '';
                if (q.type === 'ox-quiz') {
                    userAnswer = document.getElementById(`q${index}`).value;
                } else if (q.options) {
                    const selected = document.querySelector(`input[name="q${index}"]:checked`);
                    if (selected) userAnswer = selected.value;
                } else {
                    const input = document.querySelector(`input[name="q${index}"]`);
                    if (input) userAnswer = input.value;
                }

                // Simple matching (case-insensitive, trimmed)
                const isCorrect = userAnswer && q.answer && userAnswer.trim().toLowerCase() === q.answer.trim().toLowerCase();
                if (isCorrect) score++;

                answers.push({
                    questionId: index + 1,
                    question: q.question,
                    userAnswer: userAnswer,
                    correctAnswer: q.answer,
                    isCorrect: isCorrect,
                    explanation: q.explanation // Assuming explanation is part of quizData
                });
            });

            userAnswers = answers; // Save for review

            // Show Result
            document.getElementById('quizCard').style.display = 'none';
            document.getElementById('resultCard').style.display = 'block';
            document.getElementById('scoreDisplay').textContent = `${score}ì  / ${total}ë¬¸ì œ`;
            const accuracy = Math.round((score / total) * 100);
            document.getElementById('accuracyDisplay').textContent = `ì •ë‹µë¥ : ${accuracy}%`;

            // Save to Notion
            const studentName = document.getElementById('studentName').value;
            try {
                const response = await fetch('/.netlify/functions/notion', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        action: 'submit',
                        materialId: materialId,
                        studentName: studentName,
                        score: score,
                        total: total,
                        answers: answers.map(a => `Q${a.questionId}. ${a.userAnswer}`).join('\n')
                    })
                });
                const result = await response.json();
                if (result.pageId) {
                    localStorage.setItem('lastResultPageId', result.pageId);
                }
            } catch (error) {
                console.error('Failed to submit results', error);
                alert('ê²°ê³¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„ ìƒë‹˜ê»˜ í™”ë©´ì„ ë³´ì—¬ì£¼ì„¸ìš”.');
            }
        }

        function startReview() {
            document.getElementById('resultCard').style.display = 'none';
            document.getElementById('reviewCard').style.display = 'block';

            const container = document.getElementById('reviewContainer');
            container.innerHTML = '';

            const wrongAnswers = userAnswers.filter(a => !a.isCorrect);

            if (wrongAnswers.length === 0) {
                container.innerHTML = '<p>í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤! ì™„ë²½í•©ë‹ˆë‹¤.</p>';
                return;
            }

            wrongAnswers.forEach(item => {
                const div = document.createElement('div');
                div.className = 'question-card';
                div.style.backgroundColor = '#fef2f2'; // Light red bg
                div.style.border = '1px solid #fecaca';

                div.innerHTML = `
                    <h3>Q${item.questionId}. ${item.question}</h3>
                    <p><strong>ë‚˜ì˜ ë‹µ:</strong> <span style="color: red; text-decoration: line-through;">${item.userAnswer || '(ë¯¸ì…ë ¥)'}</span></p>
                    <p><strong>ì •ë‹µ:</strong> <span style="color: green;">${item.correctAnswer}</span></p>
                    <div style="background: #fff; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <strong>ğŸ’¡ í•´ì„¤/íŒíŠ¸:</strong>
                        <p>${item.explanation || 'í•´ì„¤ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function finishReview() {
            const resultPageId = localStorage.getItem('lastResultPageId');
            const btn = document.querySelector('#reviewCard .btn');
            btn.textContent = 'ì™„ë£Œ ì²˜ë¦¬ ì¤‘...';
            btn.disabled = true;

            if (resultPageId) {
                try {
                    await fetch('/.netlify/functions/notion', {
                        method: 'POST',
                        headers: getHeaders(),
                        body: JSON.stringify({
                            action: 'review_complete',
                            pageId: resultPageId
                        })
                    });
                } catch (e) {
                    console.error('Failed to update review status', e);
                    // Continue anyway
                }
            }

            alert('ë³µìŠµì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í™ˆìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
            window.location.href = 'index.html';
        }
    </script>
</body>

</html>
