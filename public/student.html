<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ - í€´ì¦ˆ í’€ê¸°</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* Student Specific Styles */
        body {
            background-color: #f0f9ff;
            /* Light Sky Blue Background */
        }

        .container {
            max-width: 800px;
        }

        .card {
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid #e0f2fe;
        }

        h1,
        h2,
        h3 {
            color: #0ea5e9;
            /* Sky Blue 500 */
        }

        .btn {
            background-color: #0ea5e9;
            border-radius: 50px;
            /* Pill shape */
            font-weight: bold;
            transition: transform 0.2s;
        }

        .btn:hover {
            background-color: #0284c7;
            transform: scale(1.05);
        }

        .question-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid #f0f9ff;
            transition: transform 0.2s;
        }

        .question-card:hover {
            transform: translateY(-2px);
            border-color: #bae6fd;
        }

        /* Character Animation */
        .character-container {
            text-align: center;
            margin: 2rem 0;
        }

        .character {
            font-size: 5rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-20px);
            }

            60% {
                transform: translateY(-10px);
            }
        }

        /* OX Buttons Horizontal */
        .ox-container {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .ox-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            font-size: 2rem;
            border: 2px solid #ddd;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ox-btn:hover {
            transform: scale(1.1);
        }

        .ox-btn.selected {
            background-color: #0ea5e9;
            color: white;
            border-color: #0ea5e9;
        }
    </style>
</head>

<body>
    <div class="container">
        <header style="text-align: center;">
            <h1>ğŸ“ ì¦ê±°ìš´ í€´ì¦ˆ ì‹œê°„!</h1>
        </header>

        <!-- Login Section -->
        <div class="card" id="loginCard" style="text-align: center;">
            <div class="character-container">
                <div class="character">ğŸ¶</div>
                <p>ì•ˆë…•? ë‚˜ëŠ” í€´ì¦ˆ ë„ìš°ë¯¸ ë©ë©ì´ì•¼!</p>
            </div>
            <h2>ì¤€ë¹„ëë‹ˆ?</h2>
            <p>ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì‹œì‘í•´ë³´ì!</p>
            <input type="text" id="studentName" placeholder="ì´ë¦„ (ì˜ˆ: ê¹€ì² ìˆ˜)"
                style="text-align: center; font-size: 1.2rem;">
            <br>
            <button class="btn" onclick="startQuiz()"
                style="margin-top: 1rem; padding: 1rem 3rem; font-size: 1.2rem;">Start!</button>
        </div>

        <!-- Loading -->
        <div id="loading" style="display: none; text-align: center;">
            <div class="character" style="font-size: 3rem;">â³</div>
            <p>ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì¤˜!</p>
        </div>

        <!-- Quiz Section -->
        <div class="card" id="quizCard" style="display: none;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; align-items: center;">
                <h2 id="quizTitle" style="margin: 0;">í€´ì¦ˆ ì œëª©</h2>
                <div id="timer" style="font-weight: bold; color: #f59e0b; font-size: 1.2rem;">00:00</div>
            </div>

            <div id="questionsContainer"></div>

            <button class="btn" onclick="submitQuiz()" style="margin-top: 2rem; width: 100%;">ë‹¤ í’€ì—ˆì–´ìš”! ì œì¶œí•˜ê¸°</button>
        </div>

        <!-- Result Section -->
        <div class="card" id="resultCard" style="display: none; text-align: center;">
            <div class="character" style="font-size: 4rem;">ğŸ‰</div>
            <h2>ì™€ìš°! ìˆ˜ê³ í–ˆì–´!</h2>
            <div style="margin: 2rem 0;">
                <h3 style="font-size: 3rem; margin: 0; color: #0ea5e9;" id="scoreDisplay">0ì </h3>
                <p id="accuracyDisplay" style="color: #666;">ì •ë‹µë¥ : 0%</p>
            </div>
            <p>ê²°ê³¼ê°€ ì„ ìƒë‹˜ê»˜ ì „ì†¡ë˜ì—ˆì–´.</p>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                <button class="btn" onclick="startReview()">ì˜¤ë‹µ ë…¸íŠ¸ í™•ì¸í•˜ê¸°</button>
                <button class="btn btn-secondary" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button>
            </div>
        </div>

        <!-- Review Section -->
        <div class="card" id="reviewCard" style="display: none;">
            <h2>ğŸ“ ì˜¤ë‹µ ë…¸íŠ¸</h2>
            <p>í‹€ë¦° ë¬¸ì œë¥¼ ë‹¤ì‹œ í•œë²ˆ ì‚´í´ë³¼ê¹Œ?</p>
            <div id="reviewContainer"></div>
            <button class="btn" onclick="finishReview()" style="margin-top: 2rem; width: 100%;">ë³µìŠµ ì™„ë£Œ!</button>
        </div>
    </div>

    <script type="module">
        import { db, collection, addDoc } from './js/firebase-config.js';

        let quizData = null;
        let startTime = null;
        let timerInterval = null;
        let materialId = null;
        let notionKey = null;
        let resultsDb = null;
        let firestoreId = null;
        let userAnswers = []; // Store answers for review

        // Get ID and Credentials from URL
        const urlParams = new URLSearchParams(window.location.search);
        materialId = urlParams.get('id');
        const encodedKey = urlParams.get('k');
        const encodedDb = urlParams.get('d');
        firestoreId = urlParams.get('fid');

        if (!materialId || !encodedKey || !encodedDb) {
            // Demo mode or Error
        }

        try {
            notionKey = atob(encodedKey);
            resultsDb = atob(encodedDb);
        } catch (e) {
            console.error('Failed to decode credentials');
        }

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'x-notion-token': notionKey,
                'x-results-db': resultsDb
            };
        }

        window.startQuiz = async () => {
            const name = document.getElementById('studentName').value;
            if (!name) return alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            document.getElementById('loginCard').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            try {
                const response = await fetch(`/.netlify/functions/notion?action=fetch&id=${materialId}`, {
                    headers: getHeaders()
                });
                if (!response.ok) throw new Error('Failed to load quiz');

                const data = await response.json();
                quizData = data;

                if (quizData.title) {
                    document.getElementById('quizTitle').textContent = quizData.title;
                }

                renderQuiz();
                startTimer();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('quizCard').style.display = 'block';
            } catch (error) {
                console.error(error);
                alert('í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('loginCard').style.display = 'block';
            }
        };

        function startTimer() {
            startTime = new Date();
            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000);
                const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
                const seconds = (diff % 60).toString().padStart(2, '0');
                document.getElementById('timer').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        function renderQuiz() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            quizData.questions.forEach((q, index) => {
                const div = document.createElement('div');
                div.className = 'question-card';
                div.innerHTML = `<p style="font-size: 1.1rem;"><strong>Q${index + 1}. ${q.question}</strong></p>`;

                if (q.type === 'ox-quiz') {
                    // OX Quiz: Horizontal Flex
                    div.innerHTML += `
                        <div class="ox-container">
                            <button class="ox-btn" onclick="selectOx(this, 'O', ${index})">O</button>
                            <button class="ox-btn" onclick="selectOx(this, 'X', ${index})">X</button>
                            <input type="hidden" name="q${index}" id="q${index}">
                        </div>
                    `;
                } else if (q.options) {
                    // Multiple Choice: Vertical but styled
                    let optionsHtml = '<div class="options-container" style="display: flex; flex-direction: column; gap: 0.5rem;">';
                    q.options.forEach(opt => {
                        optionsHtml += `
                            <label class="option-label" style="padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: background 0.2s;">
                                <input type="radio" name="q${index}" value="${opt}" style="margin-right: 0.5rem;"> ${opt}
                            </label>
                        `;
                    });
                    optionsHtml += '</div>';
                    div.innerHTML += optionsHtml;
                } else {
                    div.innerHTML += `<input type="text" name="q${index}" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; margin-top: 0.5rem;">`;
                }

                container.appendChild(div);
            });

            // Add click effect to radio labels
            document.querySelectorAll('.option-label').forEach(label => {
                label.addEventListener('click', function () {
                    // Reset siblings
                    const parent = this.parentElement;
                    parent.querySelectorAll('.option-label').forEach(l => l.style.backgroundColor = 'white');
                    // Set active
                    this.style.backgroundColor = '#e0f2fe';
                    this.querySelector('input').checked = true;
                });
            });
        }

        window.selectOx = (btn, value, index) => {
            const container = btn.parentElement;
            container.querySelectorAll('.ox-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById(`q${index}`).value = value;
        };

        window.submitQuiz = async () => {
            clearInterval(timerInterval);
            const answers = [];
            let score = 0;
            const total = quizData.questions.length;

            // Calculate Time Taken
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);
            const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
            const seconds = (diff % 60).toString().padStart(2, '0');
            const timeTaken = `${minutes}ë¶„ ${seconds}ì´ˆ`;

            quizData.questions.forEach((q, index) => {
                let userAnswer = '';
                if (q.type === 'ox-quiz') {
                    userAnswer = document.getElementById(`q${index}`).value;
                } else if (q.options) {
                    const selected = document.querySelector(`input[name="q${index}"]:checked`);
                    if (selected) userAnswer = selected.value;
                } else {
                    const input = document.querySelector(`input[name="q${index}"]`);
                    if (input) userAnswer = input.value;
                }

                const isCorrect = userAnswer && q.answer && userAnswer.trim().toLowerCase() === q.answer.trim().toLowerCase();
                if (isCorrect) score++;

                answers.push({
                    questionId: index + 1,
                    question: q.question,
                    userAnswer: userAnswer,
                    correctAnswer: q.answer,
                    isCorrect: isCorrect,
                    explanation: q.explanation
                });
            });

            userAnswers = answers;
            const accuracy = Math.round((score / total) * 100);

            // Show Result
            document.getElementById('quizCard').style.display = 'none';
            document.getElementById('resultCard').style.display = 'block';
            document.getElementById('scoreDisplay').textContent = `${score}ì  / ${total}ë¬¸ì œ`;
            document.getElementById('accuracyDisplay').textContent = `ì •ë‹µë¥ : ${accuracy}%`;

            // Confetti Effect
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 }
            });

            // Save to Firestore
            const studentName = document.getElementById('studentName').value;
            try {
                await addDoc(collection(db, "results"), {
                    quizId: materialId,
                    firestoreId: firestoreId, // Link to Firestore Quiz Doc
                    studentName: studentName,
                    score: score,
                    total: total,
                    accuracy: accuracy,
                    timeTaken: timeTaken,
                    answers: answers,
                    submittedAt: new Date()
                });
                console.log("Result saved to Firestore");
            } catch (e) {
                console.error("Error saving to Firestore:", e);
                alert("ê²°ê³¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ (Firestore): " + e.message);
            }

            // Save to Notion
            try {
                const response = await fetch('/.netlify/functions/notion', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        action: 'submit',
                        materialId: materialId,
                        studentName: studentName,
                        score: score,
                        accuracy: accuracy,
                        timeTaken: timeTaken,
                        answers: answers
                    })
                });
                const result = await response.json();
                if (result.pageId) {
                    localStorage.setItem('lastResultPageId', result.pageId);
                }
            } catch (error) {
                console.error('Failed to submit results to Notion', error);
            }
        };

        window.startReview = () => {
            document.getElementById('resultCard').style.display = 'none';
            document.getElementById('reviewCard').style.display = 'block';

            const container = document.getElementById('reviewContainer');
            container.innerHTML = '';

            const wrongAnswers = userAnswers.filter(a => !a.isCorrect);

            if (wrongAnswers.length === 0) {
                container.innerHTML = '<p style="text-align:center; font-size:1.2rem;">í‹€ë¦° ë¬¸ì œê°€ ì—†ì–´! ì •ë§ ëŒ€ë‹¨í•´! ğŸ‘</p>';
                // confetti again?
                return;
            }

            wrongAnswers.forEach(item => {
                const div = document.createElement('div');
                div.className = 'question-card';
                div.style.backgroundColor = '#fff1f2'; // Light Red
                div.style.border = '2px solid #fda4af';

                div.innerHTML = `
                    <h3>Q${item.questionId}. ${item.question}</h3>
                    <p><strong>ë‚˜ì˜ ë‹µ:</strong> <span style="color: #e11d48; text-decoration: line-through;">${item.userAnswer || '(ë¯¸ì…ë ¥)'}</span></p>
                    <p><strong>ì •ë‹µ:</strong> <span style="color: #059669; font-weight:bold;">${item.correctAnswer}</span></p>
                    <div style="background: #fff; padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #ddd;">
                        <strong>ğŸ’¡ ì„ ìƒë‹˜ì˜ íŒíŠ¸:</strong>
                        <p>${item.explanation || 'í•´ì„¤ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</p>
                    </div>
                `;
                container.appendChild(div);
            });
        };

        window.finishReview = async () => {
            const resultPageId = localStorage.getItem('lastResultPageId');
            const btn = document.querySelector('#reviewCard .btn');
            btn.textContent = 'ì™„ë£Œ ì²˜ë¦¬ ì¤‘...';
            btn.disabled = true;

            // Confetti
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#0ea5e9', '#f59e0b']
            });

            if (resultPageId) {
                try {
                    await fetch('/.netlify/functions/notion', {
                        method: 'POST',
                        headers: getHeaders(),
                        body: JSON.stringify({
                            action: 'review_complete',
                            pageId: resultPageId
                        })
                    });
                } catch (e) {
                    console.error('Failed to update review status', e);
                }
            }

            setTimeout(() => {
                alert('ë³µìŠµ ì™„ë£Œ! ì°¸ ì˜í–ˆì–´!');
                window.location.reload();
            }, 1000);
        };
    </script>
</body>

</html>
