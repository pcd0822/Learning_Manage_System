<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교사 - 자료 생성</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script type="module">
        import { loginWithGoogle, logout, checkAuthState } from './js/auth.js';
        import { db, collection, addDoc, doc, getDoc, setDoc } from './js/firebase-config.js';

        let currentUser = null;
        let currentQuizData = null;

        // Make functions available globally
        window.login = async () => {
            try {
                await loginWithGoogle();
            } catch (e) {
                alert('로그인 실패: ' + e.message);
            }
        };

        window.logoutUser = async () => {
            await logout();
            window.location.reload();
        };

        window.saveConfig = async () => {
            if (!currentUser) return alert('로그인이 필요합니다.');

            const key = document.getElementById('notionKey').value;
            const mDb = document.getElementById('materialsDb').value;
            const rDb = document.getElementById('resultsDb').value;

            if (!key || !mDb || !rDb) return alert('모든 정보를 입력해주세요.');

            try {
                await setDoc(doc(db, "users", currentUser.uid, "settings", "notion"), {
                    notionKey: key,
                    materialsDb: mDb,
                    resultsDb: rDb
                });
                alert('설정이 저장되었습니다.');
                document.getElementById('inputForm').style.display = 'block';
            } catch (e) {
                console.error(e);
                alert('저장 실패: ' + e.message);
            }
        };

        window.addTypeRow = () => {
            const container = document.getElementById('typeConfigContainer');
            const div = document.createElement('div');
            div.className = 'type-row';
            div.style.display = 'flex';
            div.style.gap = '0.5rem';
            div.style.marginBottom = '0.5rem';

            div.innerHTML = `
                <select class="type-select">
                    <option value="multiple-choice">선택형 (객관식)</option>
                    <option value="ox-quiz">OX 퀴즈</option>
                    <option value="short-answer">단답형</option>
                    <option value="fill-in-the-blank">빈칸 채우기</option>
                    <option value="essay">논술형</option>
                    <option value="inquiry">탐구과제형</option>
                </select>
                <input type="number" class="count-input" value="1" min="1" max="10">
                <button class="btn btn-delete" onclick="this.parentElement.remove()">삭제</button>
            `;
            container.appendChild(div);
        };

        window.generateQuiz = async () => {
            const topic = document.getElementById('topic').value;
            let context = document.getElementById('context').value;
            const promptRequirements = document.getElementById('promptRequirements').value;
            const videoUrl = document.getElementById('videoUrl').value;
            const imageUrl = document.getElementById('imageUrl').value;
            const fileInput = document.getElementById('fileUpload');

            // Gather Type Config
            const config = [];
            document.querySelectorAll('.type-row').forEach(row => {
                config.push({
                    type: row.querySelector('.type-select').value,
                    count: row.querySelector('.count-input').value
                });
            });

            if (config.length === 0) return alert('최소 1개 이상의 문제 유형을 추가해주세요.');
            if (!topic && !context && !fileInput.files[0]) return alert('주제, 학습 내용, 또는 파일 중 하나는 반드시 입력해야 합니다.');

            document.getElementById('inputForm').style.display = 'none';
            document.getElementById('configSection').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            // Process File Upload (Client-side)
            let fileData = null;
            let fileType = null;

            if (fileInput.files[0]) {
                const file = fileInput.files[0];
                fileType = file.type;

                try {
                    if (file.type === 'application/pdf') {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        let pdfText = "";

                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            pdfText += `[Page ${i}]\n${pageText}\n\n`;
                        }
                        context += `\n\n[업로드된 PDF 내용]\n${pdfText}`;
                    } else if (file.type.startsWith('image/')) {
                        fileData = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result.split(',')[1]);
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                    }
                } catch (e) {
                    console.error(e);
                    alert('파일 처리 실패: ' + e.message);
                    resetForm();
                    return;
                }
            }

            // Append prompt requirements to context or send separately
            // Here we append it to the prompt for simplicity in the proxy
            const fullPrompt = `${topic}\n\n[추가 요구사항]\n${promptRequirements}`;

            try {
                const response = await fetch('/.netlify/functions/openai-proxy', {
                    method: 'POST',
                    headers: await getHeaders(), // Now async to get from Firestore if needed, but we use local vars for now
                    body: JSON.stringify({
                        prompt: fullPrompt,
                        context,
                        videoUrl,
                        imageUrl,
                        config,
                        fileData, // Only for images
                        fileType
                    })
                });

                if (!response.ok) throw new Error('Generation failed');

                const data = await response.json();
                currentQuizData = data;
                renderEditablePreview(data);
            } catch (error) {
                alert('오류가 발생했습니다: ' + error.message);
                resetForm();
            }
        };

        window.renderEditablePreview = (data) => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('previewArea').style.display = 'block';

            const container = document.getElementById('quizPreview');
            container.innerHTML = `
                <label>퀴즈 제목</label>
                <input type="text" id="editTitle" value="${data.title}" style="width: 100%; font-size: 1.2rem; margin-bottom: 1rem;">
            `;

            data.questions.forEach((q, index) => {
                let html = `<div class="question-card" id="q-card-${index}">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>Q${index + 1}</strong>
                        <button class="btn btn-delete" style="padding: 0.2rem 0.5rem;" onclick="removeQuestion(${index})">삭제</button>
                    </div>
                    <textarea id="q-text-${index}" style="width:100%; margin-top:0.5rem;">${q.question}</textarea>
                    <input type="hidden" id="q-type-${index}" value="${q.type}">
                    `;

                if (q.options) {
                    html += `<div id="q-options-${index}">`;
                    q.options.forEach((opt, optIdx) => {
                        html += `<input type="text" class="q-option-${index}" value="${opt}" style="width:100%; margin-top:0.2rem;">`;
                    });
                    html += `</div>`;
                } else if (q.type === 'ox-quiz') {
                    html += `<p>OX 퀴즈 (옵션 수정 불가)</p>`;
                }

                html += `<label style="margin-top:0.5rem; display:block;">정답</label>
                         <input type="text" id="q-answer-${index}" value="${q.answer}" style="width:100%;">
                         <label style="margin-top:0.5rem; display:block;">해설</label>
                         <textarea id="q-explanation-${index}" style="width:100%;">${q.explanation || ''}</textarea>
                         </div>`;
                container.innerHTML += html;
            });
        };

        window.removeQuestion = (index) => {
            const card = document.getElementById(`q-card-${index}`);
            if (card) card.remove();
        };

        window.saveAndPublish = async () => {
            if (!currentUser) return alert('로그인이 필요합니다.');

            // Reconstruct Quiz Data from Inputs
            const title = document.getElementById('editTitle').value;
            const questions = [];

            // Iterate over potential questions (using original indices is risky if deleted, better to query DOM)
            const cards = document.querySelectorAll('.question-card');
            cards.forEach((card, idx) => {
                // Extract index from ID "q-card-X"
                const originalIndex = card.id.split('-')[2];

                const questionText = document.getElementById(`q-text-${originalIndex}`).value;
                const type = document.getElementById(`q-type-${originalIndex}`).value;
                const answer = document.getElementById(`q-answer-${originalIndex}`).value;
                const explanation = document.getElementById(`q-explanation-${originalIndex}`).value;

                const qObj = {
                    question: questionText,
                    type: type,
                    answer: answer,
                    explanation: explanation
                };

                if (type === 'multiple-choice') { // Or other types with options
                    const optionInputs = document.querySelectorAll(`.q-option-${originalIndex}`);
                    if (optionInputs.length > 0) {
                        qObj.options = Array.from(optionInputs).map(input => input.value);
                    }
                }

                questions.push(qObj);
            });

            const finalQuizData = { title, questions };

            const btn = document.querySelector('#previewArea .btn');
            btn.textContent = '저장 및 발행 중...';
            btn.disabled = true;

            try {
                // 1. Save to Firestore
                const docRef = await addDoc(collection(db, "quizzes"), {
                    userId: currentUser.uid,
                    title: title,
                    data: finalQuizData,
                    createdAt: new Date()
                });

                // 2. Publish to Notion (Optional, but requested)
                // Get config from Firestore
                const settingsSnap = await getDoc(doc(db, "users", currentUser.uid, "settings", "notion"));
                if (settingsSnap.exists()) {
                    const settings = settingsSnap.data();
                    const response = await fetch('/.netlify/functions/notion', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-notion-token': settings.notionKey,
                            'x-materials-db': settings.materialsDb
                        },
                        body: JSON.stringify({
                            action: 'publish',
                            title: title,
                            quizData: finalQuizData,
                            count: questions.length
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showResult(result.pageId, settings.notionKey, settings.resultsDb, docRef.id); // Pass credentials and Firestore ID
                    } else {
                        console.error("Notion publish failed");
                        alert("Firestore에는 저장되었으나 Notion 발행에 실패했습니다.");
                        // Still show success for Firestore?
                        // For now, let's treat it as partial success
                        showResult(result.pageId, settings.notionKey, settings.resultsDb, docRef.id);
                    }
                } else {
                    alert('Notion 설정이 없어 Firestore에만 저장되었습니다.');
                    // Redirect to dashboard or show link?
                    // Without Notion Page ID, we can't generate the link as per current architecture (which relies on Notion Page ID)
                    // We need to decide: Does the student link use Notion ID or Firestore ID?
                    // The request says "Notion DB에 배포... 로컬 환경이 달라져도 학습관리 가능"
                    // So we should probably support both, but for now let's stick to Notion ID for the link if available.
                    // If not, we might need a Firestore-based viewer.
                    // For this iteration, let's assume Notion is still the primary "Viewer" for students via the ID.
                }

            } catch (error) {
                console.error(error);
                alert('저장 실패: ' + error.message);
                btn.textContent = '저장 및 발행하기';
                btn.disabled = false;
            }
        };

        window.showResult = (pageId, key, rDb, firestoreId) => {
            document.getElementById('previewArea').style.display = 'none';
            document.getElementById('resultArea').style.display = 'block';

            const encodedKey = btoa(key);
            const encodedDb = btoa(rDb);

            const link = `${window.location.origin}/student.html?id=${pageId}&k=${encodedKey}&d=${encodedDb}&fid=${firestoreId}`;
            document.getElementById('shareLink').value = link;
        };

        window.copyLink = () => {
            const copyText = document.getElementById("shareLink");
            copyText.select();
            document.execCommand("copy");
            alert("링크가 클립보드에 복사되었습니다!");
        };

        window.resetForm = () => {
            document.getElementById('inputForm').style.display = 'block';
            document.getElementById('configSection').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('previewArea').style.display = 'none';
            currentQuizData = null;
        };

        // Auth State Listener
        checkAuthState(async (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('authSection').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>환영합니다, ${user.displayName}님!</span>
                        <button class="btn btn-secondary" onclick="logoutUser()" style="width: auto; padding: 0.5rem 1rem; margin: 0;">로그아웃</button>
                        <a href="dashboard.html" class="btn" style="width: auto; padding: 0.5rem 1rem; margin: 0;">대시보드</a>
                    </div>
                `;
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('loginOverlay').style.display = 'none';

                // Load Settings
                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid, "settings", "notion"));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('notionKey').value = data.notionKey;
                        document.getElementById('materialsDb').value = data.materialsDb;
                        document.getElementById('resultsDb').value = data.resultsDb;
                        document.getElementById('inputForm').style.display = 'block';
                    }
                } catch (e) {
                    console.error("Error loading settings:", e);
                }

            } else {
                document.getElementById('authSection').innerHTML = `
                    <button class="btn" onclick="login()">Google 로그인</button>
                `;
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('loginOverlay').style.display = 'flex';
            }
        });

        // Helper for headers (legacy support if needed, but we use direct args now)
        async function getHeaders() {
            // ... implementation if needed, but we are passing args directly
            return {};
        }
    </script>
</head>

<body>
    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>학습 자료 생성</h1>
                <p>AI를 활용하여 맞춤형 퀴즈를 생성하고 Notion에 배포하세요.</p>
            </div>
            <div id="authSection">
                <!-- Auth buttons injected here -->
            </div>
        </header>

        <div id="loginOverlay"
            style="display: none; flex-direction: column; align-items: center; justify-content: center; height: 300px; background: #f8f9fa; border-radius: 12px; margin-top: 2rem;">
            <h2>로그인이 필요합니다</h2>
            <p>서비스를 이용하려면 Google 계정으로 로그인해주세요.</p>
            <button class="btn" onclick="login()" style="margin-top: 1rem;">Google 로그인</button>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Config Section -->
            <div class="card" id="configSection">
                <h2>⚙️ 설정</h2>
                <p>Notion 연동 정보를 입력해주세요 (최초 1회 저장).</p>
                <input type="password" id="notionKey" placeholder="Notion Integration Token (secret_...)">
                <input type="text" id="materialsDb" placeholder="학습자료 DB ID">
                <input type="text" id="resultsDb" placeholder="학습결과 DB ID">
                <button class="btn btn-secondary" onclick="saveConfig()">설정 저장하기</button>
            </div>

            <div class="card" id="inputForm" style="display: none;">
                <label for="topic">학습 주제 (제목)</label>
                <input type="text" id="topic" placeholder="예: 광합성의 원리">

                <label for="context">학습 내용 (텍스트)</label>
                <textarea id="context" rows="6"
                    placeholder="여기에 학습할 본문 내용을 입력하거나 붙여넣으세요. AI가 이 내용을 바탕으로 문제를 출제합니다."></textarea>

                <label for="promptRequirements">프롬프트 요구사항 (AI에게 요청할 구체적인 지시사항)</label>
                <textarea id="promptRequirements" rows="3"
                    placeholder="예: 초등학생이 이해하기 쉽게 만들어줘, 3번 문제는 아주 어렵게 내줘 등"></textarea>

                <label for="videoUrl">동영상 링크 (YouTube 등)</label>
                <input type="text" id="videoUrl" placeholder="https://www.youtube.com/watch?v=...">

                <label for="imageUrl">이미지 링크 (선택)</label>
                <input type="text" id="imageUrl" placeholder="https://example.com/image.jpg">

                <label for="fileUpload">학습 자료 파일 업로드 (PDF, 이미지)</label>
                <input type="file" id="fileUpload" accept=".pdf, image/*">
                <p style="font-size: 0.8rem; color: #666;">파일을 업로드하면 AI가 내용을 분석하여 문제를 출제합니다.</p>

                <label>문제 구성</label>
                <div id="typeConfigContainer">
                    <!-- Dynamic rows will be added here -->
                </div>
                <button class="btn btn-secondary" onclick="addTypeRow()"
                    style="margin-bottom: 1rem; font-size: 0.9rem;">+
                    유형 추가</button>

                <button class="btn" onclick="generateQuiz()">학습자료 및 문제 생성하기</button>
            </div>

            <div id="loading">
                <div class="spinner"></div>
                <p>AI가 문제를 생성하고 있습니다...</p>
            </div>

            <div class="card" id="previewArea" style="display: none;">
                <h2>검수 및 편집</h2>
                <p>문제를 수정하거나 삭제할 수 있습니다.</p>
                <div id="quizPreview"></div>
                <button class="btn" onclick="saveAndPublish()" style="margin-top: 1rem;">저장 및 Notion에 발행하기</button>
                <button class="btn btn-secondary" onclick="resetForm()" style="margin-top: 0.5rem;">다시 만들기</button>
            </div>

            <div class="card" id="resultArea" style="display: none;">
                <h2>발행 완료!</h2>
                <p>아래 링크를 복사하여 학생들에게 공유하세요.</p>
                <input type="text" id="shareLink" readonly>
                <button class="btn" onclick="copyLink()">링크 복사</button>
                <a href="dashboard.html" class="btn btn-secondary" style="margin-top: 1rem;">대시보드로 이동</a>
            </div>
        </div>
    </div>

    <script>
        // Initialize with one row on load (if needed, but module script handles logic)
        window.addEventListener('load', () => {
            if (document.getElementById('typeConfigContainer') && document.getElementById('typeConfigContainer').children.length === 0) {
                addTypeRow();
            }
        });
    </script>
</body>

</html>
